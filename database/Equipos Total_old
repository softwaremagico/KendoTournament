SELECT
		t1.NomEquipo as Equipo,
		ifnull(t3.NumVictorias,0) as Victorias,
		ifnull(t2.TotalDuelos,0) as Duelos,
		ifnull(t1.TotalPtos,0) as Puntos
FROM
	(SELECT 
			t1.NomEquipo as NomEquipo, 
			sum(TotalPtos) as TotalPtos 
	FROM 
			(SELECT 
					t2.Name as NomEquipo, 
					CASE 
						WHEN PointPlayer1A in ('K','M','T','D','I','H')  THEN 1 
						ELSE 0 END + CASE 
											WHEN PointPlayer1B in ('K','M','T','D','I','H')  THEN 1 
											ELSE 0 END
					as TotalPtos 
			FROM 
					team t2 
					INNER JOIN 
					fight t3 
					ON t2.Name = t3.Team1 
					AND t2.Tournament = t3.Tournament 
					AND (t2.Tournament = 'VII Open i Clínic (Femenino)' OR 'All' = 'VII Open i Clínic (Femenino)') 
					INNER JOIN 
					duel t4 
					ON t3.ID = t4.Fight 
			WHERE 
					t2.Position = t4.OrderPlayer
					
			UNION ALL 
			
			SELECT 
					t2.Name as NomEquipo, 
					CASE 
						WHEN PointPlayer2A in ('K','M','T','D','I','H')  THEN 1 
						ELSE 0 END + CASE 
											WHEN PointPlayer2B in ('K','M','T','D','I','H')  THEN 1 
											ELSE 0 END
					as TotalPtos
			FROM 
					team t2 
					INNER JOIN 
					fight t3 
					ON t2.Name = t3.Team2 
					AND t2.Tournament = t3.Tournament 
					AND (t2.Tournament = 'VII Open i Clínic (Femenino)' OR 'All' = 'VII Open i Clínic (Femenino)') 
					INNER JOIN 
					duel t4 
					ON t3.ID = t4.Fight 
			WHERE 
				t2.Position = t4.OrderPlayer

			) t1 
	GROUP BY 
			t1.NomEquipo
	) t1 -- Ptos de cada Equipo
	LEFT OUTER JOIN
	(	SELECT 
			CASE 
				WHEN TotalDuelo1 > TotalDuelo2 THEN t1.Team  
				ELSE t2.Team 
			END as NomEquipo,
			count(Distinct t1.IdDuelo) as TotalDuelos
	FROM 
		(SELECT 
				t2.Name as Team,
				t4.ID as IdDuelo, 
				Sum(CASE 
					WHEN PointPlayer1A in ('K','M','T','D','I','H')  THEN 1 
					ELSE 0 END + CASE 
									WHEN PointPlayer1B in ('K','M','T','D','I','H')  THEN 1 
									ELSE 0 END )
				as TotalDuelo1 
		FROM 
				team t2 
				INNER JOIN 
				fight t3 
				ON t2.Name = t3.Team1 
				AND t2.Tournament = t3.Tournament 
				AND (t2.Tournament = 'VII Open i Clínic (Femenino)' OR 'All' = 'VII Open i Clínic (Femenino)') 
				INNER JOIN duel t4 
				ON t3.ID = t4.Fight 
		WHERE 
				t2.Position = t4.OrderPlayer 
		GROUP BY
				t2.Name,
				t4.ID 
		)t1 
		INNER JOIN 
		(SELECT 
				t2.Name as Team,
				t4.ID as IdDuelo, 
				Sum(CASE 
					WHEN PointPlayer2A in ('K','M','T','D','I','H')  THEN 1 
					ELSE 0 END + CASE 
									WHEN PointPlayer2B in ('K','M','T','D','I','H')  THEN 1 
									ELSE 0 END )
				as TotalDuelo2 
		FROM 
				team t2 
				INNER JOIN fight t3 
				ON t2.Name = t3.Team2 
				AND t2.Tournament = t3.Tournament 
				AND (t2.Tournament = 'VII Open i Clínic (Femenino)' OR 'All' = 'VII Open i Clínic (Femenino)')
				INNER JOIN duel t4
				ON t3.ID = t4.Fight
		WHERE 
				t2.Position = t4.OrderPlayer 
		GROUP BY
				t2.Name,
				t4.ID 
		)t2
		ON t1.IdDuelo = t2.IdDuelo 
		WHERE 
				TotalDuelo1 <> TotalDuelo2   
		GROUP BY
				CASE 
					WHEN TotalDuelo1 > TotalDuelo2 THEN t1.Team  
					ELSE t2.Team 
				END
		) t2 -- Duelos ganados de cada equipo
		ON t1.NomEquipo = t2.NomEquipo
		LEFT OUTER JOIN
		(SELECT
				CASE
						WHEN VictoriaIzq >  VictoriaDer THEN EquipoIzq
						WHEN VictoriaIzq < VictoriaDer THEN EquipoDer
						-- ELSE (select  case when winner = -1 then team1 when winner = 1 then team2 else 'Combate no acabado' end    from  fight t0 where t1. idcombate = t0.id)
				END as NomEquipo,
				count(idcombate) as NumVictorias
			FROM
			(SELECT 
					idcombate,
					EquipoIzq,
					EquipoDer,
					Sum(NumDuelosGanados1) as VictoriaIzq,
					Sum(NumDuelosGanados2) as VictoriaDer
			FROM 
					(SELECT
							t1.Team as EquipoIzq,
							t2.Team as EquipoDer,
							t1.IdCombate,
							CASE WHEN TotalDuelo1 > TotalDuelo2 THEN 1
							ELSE 0 END as NumDuelosGanados1,
							CASE WHEN TotalDuelo2 > TotalDuelo1 THEN 1
							ELSE 0 END  as NumDuelosGanados2
									
					FROM	
						(SELECT 
								t2.Name as Team,
								t3.Id as IdCombate,
								t4.ID as IdDuelo, 
								Sum(CASE 
									WHEN PointPlayer1A in ('K','M','T','D','I','H')  THEN 1 
									ELSE 0 END + CASE 
									WHEN PointPlayer1B in ('K','M','T','D','I','H')  THEN 1 
									ELSE 0 END )
								as TotalDuelo1 
						FROM 
								team t2 
								INNER JOIN 
								fight t3 
								ON t2.Name = t3.Team1 
								AND t2.Tournament = t3.Tournament 
								AND (t2.Tournament = 'VII Open i Clínic (Femenino)' OR 'All' = 'VII Open i Clínic (Femenino)') 
								INNER JOIN duel t4 
								ON t3.ID = t4.Fight 
						WHERE 
								t2.Position = t4.OrderPlayer 
						GROUP BY
								t2.Name,
								t3.ID,
								t4.ID 
						)t1 
						INNER JOIN 
						(SELECT 
								t2.Name as Team,
								t3.Id as IdCombate,
								t4.ID as IdDuelo, 
								Sum(CASE 
									WHEN PointPlayer2A in ('K','M','T','D','I','H')  THEN 1 
									ELSE 0 END + CASE 
									WHEN PointPlayer2B in ('K','M','T','D','I','H')  THEN 1 
									ELSE 0 END )
								as TotalDuelo2 
						FROM 
								team t2 
								INNER JOIN fight t3 
								ON t2.Name = t3.Team2 
								AND t2.Tournament = t3.Tournament 
								AND (t2.Tournament = 'VII Open i Clínic (Femenino)' OR 'All' = 'VII Open i Clínic (Femenino)')
								INNER JOIN duel t4
								ON t3.ID = t4.Fight
						WHERE 
								t2.Position = t4.OrderPlayer 
						GROUP BY
								t2.Name,
								t3.ID,
								t4.ID 
						)t2
						ON t1.IdDuelo = t2.IdDuelo 
						AND t1.IdCombate = t2.IDCombate
					WHERE 
							TotalDuelo1 <> TotalDuelo2
					)t1
				GROUP BY
						idcombate,
						EquipoIzq,
						EquipoDer
			) t1
		GROUP BY
		CASE
				WHEN VictoriaIzq >  VictoriaDer THEN EquipoIzq
				WHEN VictoriaIzq < VictoriaDer THEN EquipoDer
				-- ELSE (select  case when winner = -1 then team1 when winner = 1 then team2  else 'Combate no acabado' end    from  fight t0 where t1. idcombate = t0.id)
		END  
		)t3 -- Victorias de cada equipo
		ON t1.NomEquipo = t3.NomEquipo
ORDER BY
		ifnull(t3.NumVictorias,0) DESC,
		ifnull(t2.TotalDuelos,0) DESC,
		ifnull(t1.TotalPtos,0)  DESC,
		t1.NomEquipo